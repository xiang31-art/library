# C言語 入出力関数ガイド

このガイドでは、C言語の標準入出力関数である `scanf()` と `printf()` の使い方を網羅的に解説します。特にバッファクリアとエラー処理に重点を置いています。

## 目次

1. [scanf() 基本](#scanf-基本)
2. [printf() 基本](#printf-基本)
3. [バッファクリア](#バッファクリア)
4. [エラー処理](#エラー処理)
5. [書式指定子一覧](#書式指定子一覧)
6. [実践例](#実践例)

---

## scanf() 基本

### 基本構文

`scanf()` は標準入力からデータを読み取り、指定した変数に格納する関数です。戻り値は正常に読み取れた項目数を返します。失敗時は `EOF`（通常-1）を返します。

```c
int scanf(const char *format, ...);
```

### 基本的な使い方

整数、浮動小数点数、文字、文字列など、様々な型のデータを読み取ることができます。変数のアドレスを渡す必要がありますが、配列の場合は配列名がすでにアドレスを表すため `&` は不要です。

```c
#include <stdio.h>

int main() {
    int num;
    float price;
    char ch;
    char str[100];
    
    printf("整数を入力: ");
    scanf("%d", &num);  // & が必要
    
    printf("小数を入力: ");
    scanf("%f", &price);  // & が必要
    
    printf("文字を入力: ");
    scanf(" %c", &ch);  // 先頭の空白で前の改行をスキップ
    
    printf("文字列を入力: ");
    scanf("%s", str);  // & は不要（配列名はアドレス）
    
    printf("\n結果: %d, %.2f, %c, %s\n", num, price, ch, str);
    return 0;
}
```

実行例:
```
整数を入力: 42
小数を入力: 3.14
文字を入力: A
文字列を入力: Hello
結果: 42, 3.14, A, Hello
```


---

## printf() 基本

### 基本構文

`printf()` は指定した書式で標準出力にデータを出力する関数です。戻り値は出力した文字数を返します。エラー時は負の値を返します。

```c
int printf(const char *format, ...);
```

### 基本的な使い方

様々な型のデータを整形して出力できます。書式指定子を使って出力形式を細かく制御できます。幅指定、桁数指定、フラグなどを組み合わせることで、見やすい表形式の出力も可能です。

```c
#include <stdio.h>

int main() {
    int num = 42;
    float price = 99.99;
    char ch = 'A';
    char str[] = "Hello";
    
    printf("整数: %d\n", num);
    printf("小数: %.2f\n", price);  // 小数点以下2桁
    printf("文字: %c\n", ch);
    printf("文字列: %s\n", str);
    
    // 幅指定と整形
    printf("右詰め: %10d\n", num);
    printf("左詰め: %-10d\n", num);
    printf("ゼロ埋め: %05d\n", num);
    
    return 0;
}
```

実行例:
```
整数: 42
小数: 99.99
文字: A
文字列: Hello
右詰め:         42
左詰め: 42        
ゼロ埋め: 00042
```

---

## バッファクリア

### バッファとは

キーボードから入力されたデータは、プログラムに直接渡されるのではなく、一時的に入力バッファという領域に保存されます。Enterキーを押すと、バッファの内容がプログラムに渡されます。`scanf()` が読み取りに失敗したり、余分なデータが入力された場合、そのデータはバッファに残り続け、次の入力処理に影響を与えます。

### なぜバッファクリアが必要か

`scanf()` が期待する形式と異なるデータが入力されると、読み取りに失敗し、不正なデータがバッファに残ります。この残ったデータが次の `scanf()` に渡されると、ユーザーの入力を待たずに即座に失敗します。これを防ぐため、バッファに残ったデータを明示的に削除する必要があります。

```c
#include <stdio.h>

int main() {
    int num1, num2;
    
    // バッファクリアなし（問題あり）
    printf("1つ目の数値: ");
    scanf("%d", &num1);  // ユーザーが "abc" と入力
    
    printf("2つ目の数値: ");
    scanf("%d", &num2);  // 入力を待たずに即座に失敗！
    
    return 0;
}
```

実行例（問題のある動作）:
```
1つ目の数値: abc
2つ目の数値: （入力を待たずに終了）
```


### バッファクリアの方法

改行文字（`\n`）までバッファから読み捨てることで、残ったデータを削除します。`while(getchar() != '\n')` が最も確実な方法です。`getchar()` は1文字読むたびにその文字をバッファから削除するため、ループで改行まで読み続けることで完全にクリアできます。

```c
#include <stdio.h>

int main() {
    int num1, num2;
    
    // バッファクリアあり（正しい）
    printf("1つ目の数値: ");
    scanf("%d", &num1);
    while(getchar() != '\n');  // バッファクリア
    
    printf("2つ目の数値: ");
    scanf("%d", &num2);
    while(getchar() != '\n');  // バッファクリア
    
    printf("結果: %d, %d\n", num1, num2);
    return 0;
}
```

実行例（正しい動作）:
```
1つ目の数値: abc
2つ目の数値: 123
結果: (不定値), 123
```

### バッファクリアが必要な場面

単独の `scanf()` の後、ループ内の `scanf()`、複数の入力処理が連続する場合など、ほぼすべての `scanf()` の後にバッファクリアが必要です。例外は、連続して同じ形式のデータを読む場合（最後に1回だけクリア）や、`%[^\n]` で行全体を読む場合（改行1文字だけ `getchar()` で削除）です。

```c
#include <stdio.h>

int main() {
    int a, b, c;
    char str[100];
    
    // パターン1: 連続する同形式の入力
    printf("3つの数値を入力: ");
    scanf("%d %d %d", &a, &b, &c);
    while(getchar() != '\n');  // 最後に1回だけ
    
    // パターン2: 行全体を読む
    printf("文字列を入力: ");
    scanf("%[^\n]", str);
    getchar();  // 改行1文字だけ削除
    
    printf("結果: %d, %d, %d, %s\n", a, b, c, str);
    return 0;
}
```

実行例:
```
3つの数値を入力: 1 2 3
文字列を入力: Hello World
結果: 1, 2, 3, Hello World
```

---

## エラー処理

### scanf() の戻り値

`scanf()` は正常に読み取れた項目数を返します。この戻り値をチェックすることで、入力が成功したか失敗したかを判定できます。失敗時は適切なエラーメッセージを表示し、再入力を促すことが重要です。戻り値をチェックしないと、不正なデータが変数に入ったまま処理が続行され、予期しない動作を引き起こします。

```c
#include <stdio.h>

int main() {
    int num;
    int result;
    
    printf("数値を入力: ");
    result = scanf("%d", &num);
    while(getchar() != '\n');
    
    if(result != 1) {
        printf("エラー: 数値の読み取りに失敗しました\n");
        return 1;
    }
    
    printf("入力された数値: %d\n", num);
    return 0;
}
```

実行例（成功）:
```
数値を入力: 42
入力された数値: 42
```

実行例（失敗）:
```
数値を入力: abc
エラー: 数値の読み取りに失敗しました
```


### ループによる再入力

入力が失敗した場合、ユーザーに再入力を促すことで、プログラムの堅牢性が向上します。`do-while` ループを使い、正しい入力が得られるまで繰り返します。ループ内では必ず毎回バッファクリアを行い、エラーメッセージを表示してユーザーに何が問題だったかを伝えます。

```c
#include <stdio.h>

int main() {
    int num;
    int result;
    
    do {
        printf("数値を入力: ");
        result = scanf("%d", &num);
        while(getchar() != '\n');  // 成功・失敗に関わらずクリア
        
        if(result != 1) {
            printf("エラー: 数値を入力してください\n");
        }
    } while(result != 1);
    
    printf("入力された数値: %d\n", num);
    return 0;
}
```

実行例:
```
数値を入力: abc
エラー: 数値を入力してください
数値を入力: xyz
エラー: 数値を入力してください
数値を入力: 42
入力された数値: 42
```

### 範囲チェック付き入力

入力値が特定の範囲内にあるかをチェックすることで、より安全なプログラムを作成できます。`scanf()` の戻り値チェックに加えて、値の範囲も検証します。範囲外の値が入力された場合は、適切なエラーメッセージを表示して再入力を促します。

```c
#include <stdio.h>

int main() {
    int age;
    int result;
    
    do {
        printf("年齢を入力 (0-150): ");
        result = scanf("%d", &age);
        while(getchar() != '\n');
        
        if(result != 1) {
            printf("エラー: 数値を入力してください\n");
        } else if(age < 0 || age > 150) {
            printf("エラー: 0～150の範囲で入力してください\n");
            result = 0;  // ループを継続
        }
    } while(result != 1);
    
    printf("入力された年齢: %d\n", age);
    return 0;
}
```

実行例:
```
年齢を入力 (0-150): abc
エラー: 数値を入力してください
年齢を入力 (0-150): 200
エラー: 0～150の範囲で入力してください
年齢を入力 (0-150): 25
入力された年齢: 25
```

### 汎用的な入力関数

エラー処理とバッファクリアを含む汎用的な入力関数を作成することで、コードの再利用性が向上します。関数化することで、プログラム全体で一貫したエラー処理が可能になり、バグの混入を防げます。

```c
#include <stdio.h>

// 整数入力（エラー処理付き）
int input_int(const char* prompt) {
    int value, result;
    do {
        printf("%s", prompt);
        result = scanf("%d", &value);
        while(getchar() != '\n');
        
        if(result != 1) {
            printf("エラー: 整数を入力してください\n");
        }
    } while(result != 1);
    return value;
}

// 範囲指定付き整数入力
int input_int_range(const char* prompt, int min, int max) {
    int value;
    do {
        value = input_int(prompt);
        if(value < min || value > max) {
            printf("エラー: %d～%dの範囲で入力してください\n", min, max);
        }
    } while(value < min || value > max);
    return value;
}

int main() {
    int age = input_int_range("年齢を入力: ", 0, 150);
    int score = input_int_range("点数を入力 (0-100): ", 0, 100);
    
    printf("\n年齢: %d\n", age);
    printf("点数: %d\n", score);
    
    return 0;
}
```

実行例:
```
年齢を入力: abc
エラー: 整数を入力してください
年齢を入力: 200
エラー: 0～150の範囲で入力してください
年齢を入力: 25
点数を入力 (0-100): 150
エラー: 0～100の範囲で入力してください
点数を入力 (0-100): 85

年齢: 25
点数: 85
```


---

## 書式指定子一覧

### scanf() の書式指定子

`scanf()` で使用できる主な書式指定子です。各指定子は特定の型のデータを読み取ります。整数は10進数だけでなく8進数や16進数でも読み取れます。文字列は空白で区切られますが、スキャンセットを使うことで空白を含む文字列も読み取れます。

| 書式 | 型 | 説明 | 例 |
|------|-----|------|-----|
| `%d` | int | 10進整数 | `scanf("%d", &num)` |
| `%i` | int | 整数（8/10/16進自動判定） | `scanf("%i", &num)` |
| `%u` | unsigned int | 符号なし整数 | `scanf("%u", &num)` |
| `%o` | int | 8進整数 | `scanf("%o", &num)` |
| `%x`, `%X` | int | 16進整数 | `scanf("%x", &num)` |
| `%f` | float | 浮動小数点数 | `scanf("%f", &f)` |
| `%lf` | double | 倍精度浮動小数点数 | `scanf("%lf", &d)` |
| `%c` | char | 1文字 | `scanf("%c", &ch)` |
| `%s` | char[] | 文字列（空白まで） | `scanf("%s", str)` |
| `%[...]` | char[] | スキャンセット | `scanf("%[^\n]", str)` |

```c
#include <stdio.h>

int main() {
    int dec, hex, oct;
    float f;
    double d;
    char ch;
    char str[100];
    char line[100];
    
    printf("10進数: "); scanf("%d", &dec); while(getchar() != '\n');
    printf("16進数: "); scanf("%x", &hex); while(getchar() != '\n');
    printf("8進数: "); scanf("%o", &oct); while(getchar() != '\n');
    printf("float: "); scanf("%f", &f); while(getchar() != '\n');
    printf("double: "); scanf("%lf", &d); while(getchar() != '\n');
    printf("文字: "); scanf(" %c", &ch); while(getchar() != '\n');
    printf("単語: "); scanf("%s", str); while(getchar() != '\n');
    printf("行全体: "); scanf("%[^\n]", line); getchar();
    
    printf("\n結果:\n");
    printf("10進数: %d\n", dec);
    printf("16進数: 0x%X\n", hex);
    printf("8進数: 0%o\n", oct);
    printf("float: %f\n", f);
    printf("double: %lf\n", d);
    printf("文字: %c\n", ch);
    printf("単語: %s\n", str);
    printf("行全体: %s\n", line);
    
    return 0;
}
```

実行例:
```
10進数: 42
16進数: FF
8進数: 77
float: 3.14
double: 2.71828
文字: A
単語: Hello
行全体: Hello World

結果:
10進数: 42
16進数: 0xFF
8進数: 077
float: 3.140000
double: 2.718280
文字: A
単語: Hello
行全体: Hello World
```

### printf() の書式指定子

`printf()` で使用できる主な書式指定子です。整数や浮動小数点数を様々な形式で出力できます。幅指定や桁数指定を組み合わせることで、見やすく整形された出力が可能です。ポインタのアドレス表示やパーセント記号そのものの出力も可能です。

| 書式 | 型 | 説明 | 例 |
|------|-----|------|-----|
| `%d`, `%i` | int | 10進整数 | `printf("%d", num)` |
| `%u` | unsigned int | 符号なし整数 | `printf("%u", num)` |
| `%o` | int | 8進整数 | `printf("%o", num)` |
| `%x`, `%X` | int | 16進整数（小文字/大文字） | `printf("%x", num)` |
| `%f` | float/double | 浮動小数点数 | `printf("%f", f)` |
| `%e`, `%E` | float/double | 指数表記 | `printf("%e", f)` |
| `%g`, `%G` | float/double | 自動選択 | `printf("%g", f)` |
| `%c` | char | 1文字 | `printf("%c", ch)` |
| `%s` | char[] | 文字列 | `printf("%s", str)` |
| `%p` | void* | ポインタ（アドレス） | `printf("%p", ptr)` |
| `%%` | - | %記号そのもの | `printf("%%")` |

```c
#include <stdio.h>

int main() {
    int num = 255;
    float f = 3.14159;
    char ch = 'A';
    char str[] = "Hello";
    int *ptr = &num;
    
    printf("10進数: %d\n", num);
    printf("8進数: %o\n", num);
    printf("16進数(小): %x\n", num);
    printf("16進数(大): %X\n", num);
    printf("固定小数点: %f\n", f);
    printf("指数表記: %e\n", f);
    printf("自動選択: %g\n", f);
    printf("文字: %c\n", ch);
    printf("文字列: %s\n", str);
    printf("アドレス: %p\n", (void*)ptr);
    printf("パーセント: 100%%\n");
    
    return 0;
}
```

実行例:
```
10進数: 255
8進数: 377
16進数(小): ff
16進数(大): FF
固定小数点: 3.141590
指数表記: 3.141590e+00
自動選択: 3.14159
文字: A
文字列: Hello
アドレス: 0x7ffd12345678
パーセント: 100%
```


### スキャンセット %[...]

スキャンセットは `scanf()` で特定の文字だけを読み取るための機能です。`%[文字セット]` で指定した文字だけを読み、`%[^文字セット]` で指定した文字以外を読みます。行全体を読む `%[^\n]` が最もよく使われます。カンマ区切りのデータを読む場合など、柔軟な入力処理が可能です。

```c
#include <stdio.h>

int main() {
    char digits[100];
    char letters[100];
    char line[100];
    char until_comma[100];
    
    // 数字だけ読む
    printf("数字を含む文字列: ");
    scanf("%[0-9]", digits);
    while(getchar() != '\n');
    
    // 英字だけ読む
    printf("英字を含む文字列: ");
    scanf("%[a-zA-Z]", letters);
    while(getchar() != '\n');
    
    // 改行以外を全部読む（行全体）
    printf("行全体: ");
    scanf("%[^\n]", line);
    getchar();
    
    // カンマまで読む
    printf("カンマ区切りデータ: ");
    scanf("%[^,]", until_comma);
    while(getchar() != '\n');
    
    printf("\n結果:\n");
    printf("数字: %s\n", digits);
    printf("英字: %s\n", letters);
    printf("行全体: %s\n", line);
    printf("カンマまで: %s\n", until_comma);
    
    return 0;
}
```

実行例:
```
数字を含む文字列: 123abc
英字を含む文字列: abc123
行全体: Hello World 123
カンマ区切りデータ: apple,banana,orange

結果:
数字: 123
英字: abc
行全体: Hello World 123
カンマまで: apple
```

### printf() の幅指定と桁数指定

幅指定は出力する文字数を指定し、桁数指定は小数点以下の桁数を指定します。右詰め、左詰め、ゼロ埋めなどの整形が可能です。表形式のデータを出力する際に非常に便利で、見やすく整列された出力を作成できます。

```c
#include <stdio.h>

int main() {
    int num = 42;
    float price = 99.99;
    char str[] = "Hello";
    
    // 幅指定（右詰め）
    printf("右詰め: [%10d]\n", num);
    printf("右詰め: [%10s]\n", str);
    
    // 幅指定（左詰め）
    printf("左詰め: [%-10d]\n", num);
    printf("左詰め: [%-10s]\n", str);
    
    // ゼロ埋め
    printf("ゼロ埋め: [%05d]\n", num);
    
    // 小数点以下の桁数
    printf("小数2桁: [%.2f]\n", price);
    printf("小数4桁: [%.4f]\n", price);
    
    // 幅と桁数の組み合わせ
    printf("組み合わせ: [%10.2f]\n", price);
    printf("組み合わせ: [%-10.2f]\n", price);
    
    return 0;
}
```

実行例:
```
右詰め: [        42]
右詰め: [     Hello]
左詰め: [42        ]
左詰め: [Hello     ]
ゼロ埋め: [00042]
小数2桁: [99.99]
小数4桁: [99.9900]
組み合わせ: [     99.99]
組み合わせ: [99.99     ]
```

### printf() のフラグ

フラグは出力形式を細かく制御するための記号です。`+` は符号を常に表示し、` `（スペース）は正数に空白を付け、`#` は別形式（16進数に0xを付けるなど）で出力します。これらを組み合わせることで、より詳細な出力制御が可能です。

```c
#include <stdio.h>

int main() {
    int pos = 42;
    int neg = -42;
    int num = 255;
    float f = 3.0;
    
    // + フラグ（符号を常に表示）
    printf("+フラグ(正): %+d\n", pos);
    printf("+フラグ(負): %+d\n", neg);
    
    // スペースフラグ（正数に空白）
    printf("スペース(正): % d\n", pos);
    printf("スペース(負): % d\n", neg);
    
    // # フラグ（別形式）
    printf("#フラグ(16進): %#x\n", num);
    printf("#フラグ(8進): %#o\n", num);
    printf("#フラグ(小数): %#.2f\n", f);
    
    return 0;
}
```

実行例:
```
+フラグ(正): +42
+フラグ(負): -42
スペース(正):  42
スペース(負): -42
#フラグ(16進): 0xff
#フラグ(8進): 0377
#フラグ(小数): 3.00
```


---

## 実践例

### 例1: ユーザー情報の入力と表示

エラー処理とバッファクリアを含む実践的な例です。複数の異なる型のデータを入力し、整形して表示します。各入力の後に適切なバッファクリアを行い、エラー時には再入力を促します。実際のアプリケーションで使える堅牢な入力処理の例です。

```c
#include <stdio.h>
#include <string.h>

int main() {
    char name[50];
    int age;
    float height;
    char address[100];
    int result;
    
    // 名前入力（行全体）
    printf("名前を入力: ");
    scanf("%[^\n]", name);
    getchar();
    
    // 年齢入力（エラー処理付き）
    do {
        printf("年齢を入力 (0-150): ");
        result = scanf("%d", &age);
        while(getchar() != '\n');
        
        if(result != 1) {
            printf("エラー: 数値を入力してください\n");
        } else if(age < 0 || age > 150) {
            printf("エラー: 0～150の範囲で入力してください\n");
            result = 0;
        }
    } while(result != 1);
    
    // 身長入力（エラー処理付き）
    do {
        printf("身長を入力 (cm): ");
        result = scanf("%f", &height);
        while(getchar() != '\n');
        
        if(result != 1) {
            printf("エラー: 数値を入力してください\n");
        } else if(height < 0 || height > 300) {
            printf("エラー: 0～300の範囲で入力してください\n");
            result = 0;
        }
    } while(result != 1);
    
    // 住所入力（行全体）
    printf("住所を入力: ");
    scanf("%[^\n]", address);
    getchar();
    
    // 結果表示（整形）
    printf("\n========== ユーザー情報 ==========\n");
    printf("名前  : %s\n", name);
    printf("年齢  : %d歳\n", age);
    printf("身長  : %.1fcm\n", height);
    printf("住所  : %s\n", address);
    printf("==================================\n");
    
    return 0;
}
```

実行例:
```
名前を入力: 山田太郎
年齢を入力 (0-150): abc
エラー: 数値を入力してください
年齢を入力 (0-150): 200
エラー: 0～150の範囲で入力してください
年齢を入力 (0-150): 25
身長を入力 (cm): xyz
エラー: 数値を入力してください
身長を入力 (cm): 175.5
住所を入力: 東京都渋谷区1-2-3

========== ユーザー情報 ==========
名前  : 山田太郎
年齢  : 25歳
身長  : 175.5cm
住所  : 東京都渋谷区1-2-3
==================================
```

### 例2: 商品管理システム

複数の商品データを入力し、表形式で整形して表示する例です。幅指定を使って列を揃え、小数点以下の桁数を統一することで、見やすい表を作成します。合計金額の計算も行い、実用的なデータ管理の例を示します。

```c
#include <stdio.h>

#define MAX_ITEMS 5

int main() {
    char names[MAX_ITEMS][50];
    int quantities[MAX_ITEMS];
    float prices[MAX_ITEMS];
    int count = 0;
    int result;
    float total = 0;
    
    printf("商品情報を入力してください（最大%d件）\n", MAX_ITEMS);
    printf("商品名に'end'と入力すると終了します\n\n");
    
    while(count < MAX_ITEMS) {
        // 商品名入力
        printf("商品名 [%d]: ", count + 1);
        scanf("%[^\n]", names[count]);
        getchar();
        
        // 終了判定
        if(strcmp(names[count], "end") == 0) {
            break;
        }
        
        // 数量入力
        do {
            printf("数量: ");
            result = scanf("%d", &quantities[count]);
            while(getchar() != '\n');
            
            if(result != 1 || quantities[count] <= 0) {
                printf("エラー: 正の整数を入力してください\n");
                result = 0;
            }
        } while(result != 1);
        
        // 価格入力
        do {
            printf("単価: ");
            result = scanf("%f", &prices[count]);
            while(getchar() != '\n');
            
            if(result != 1 || prices[count] <= 0) {
                printf("エラー: 正の数値を入力してください\n");
                result = 0;
            }
        } while(result != 1);
        
        printf("\n");
        count++;
    }
    
    // 結果表示
    printf("\n========== 商品一覧 ==========\n");
    printf("%-20s %6s %10s %12s\n", "商品名", "数量", "単価", "小計");
    printf("------------------------------------------------------\n");
    
    for(int i = 0; i < count; i++) {
        float subtotal = quantities[i] * prices[i];
        printf("%-20s %6d %10.2f %12.2f\n", 
               names[i], quantities[i], prices[i], subtotal);
        total += subtotal;
    }
    
    printf("------------------------------------------------------\n");
    printf("%39s %12.2f\n", "合計:", total);
    printf("======================================\n");
    
    return 0;
}
```

実行例:
```
商品情報を入力してください（最大5件）
商品名に'end'と入力すると終了します

商品名 [1]: りんご
数量: 10
単価: 150.50

商品名 [2]: みかん
数量: 5
単価: 299.99

商品名 [3]: バナナ
数量: 20
単価: 50.00

商品名 [4]: end

========== 商品一覧 ==========
商品名                   数量       単価         小計
------------------------------------------------------
りんご                     10     150.50      1505.00
みかん                      5     299.99      1499.95
バナナ                     20      50.00      1000.00
------------------------------------------------------
                                   合計:      4004.95
======================================
```


### 例3: メニュー選択システム

メニューから選択肢を選ぶ対話型プログラムの例です。無効な入力に対して適切なエラーメッセージを表示し、有効な選択肢が入力されるまで繰り返します。実際のアプリケーションでよく使われるパターンで、ユーザーフレンドリーなインターフェースを実現します。

```c
#include <stdio.h>

void display_menu() {
    printf("\n========== メニュー ==========\n");
    printf("1. データ入力\n");
    printf("2. データ表示\n");
    printf("3. データ削除\n");
    printf("4. 終了\n");
    printf("==============================\n");
}

int get_menu_choice() {
    int choice;
    int result;
    
    do {
        printf("選択してください (1-4): ");
        result = scanf("%d", &choice);
        while(getchar() != '\n');
        
        if(result != 1) {
            printf("エラー: 数値を入力してください\n");
        } else if(choice < 1 || choice > 4) {
            printf("エラー: 1～4の範囲で選択してください\n");
            result = 0;
        }
    } while(result != 1);
    
    return choice;
}

int main() {
    int choice;
    
    printf("メニュー選択システム\n");
    
    do {
        display_menu();
        choice = get_menu_choice();
        
        switch(choice) {
            case 1:
                printf("\n[データ入力] が選択されました\n");
                break;
            case 2:
                printf("\n[データ表示] が選択されました\n");
                break;
            case 3:
                printf("\n[データ削除] が選択されました\n");
                break;
            case 4:
                printf("\nプログラムを終了します\n");
                break;
        }
    } while(choice != 4);
    
    return 0;
}
```

実行例:
```
メニュー選択システム

========== メニュー ==========
1. データ入力
2. データ表示
3. データ削除
4. 終了
==============================
選択してください (1-4): abc
エラー: 数値を入力してください
選択してください (1-4): 5
エラー: 1～4の範囲で選択してください
選択してください (1-4): 1

[データ入力] が選択されました

========== メニュー ==========
1. データ入力
2. データ表示
3. データ削除
4. 終了
==============================
選択してください (1-4): 4

プログラムを終了します
```

### 例4: CSV形式データの読み取り

カンマ区切りのデータを読み取る例です。スキャンセット `%[^,]` を使ってカンマまでのデータを読み取り、複数のフィールドを持つデータを処理します。実際のデータファイル処理でよく使われるパターンで、構造化されたデータの入力処理を示します。

```c
#include <stdio.h>

int main() {
    char name[50];
    int age;
    char city[50];
    int result;
    
    printf("CSV形式でデータを入力してください\n");
    printf("形式: 名前,年齢,都市\n");
    printf("例: 山田太郎,25,東京\n\n");
    
    printf("データ: ");
    
    // 名前を読む（カンマまで）
    result = scanf("%[^,]", name);
    if(result != 1) {
        printf("エラー: 名前の読み取りに失敗しました\n");
        return 1;
    }
    
    // カンマをスキップ
    if(getchar() != ',') {
        printf("エラー: カンマが見つかりません\n");
        return 1;
    }
    
    // 年齢を読む
    result = scanf("%d", &age);
    if(result != 1) {
        printf("エラー: 年齢の読み取りに失敗しました\n");
        return 1;
    }
    
    // カンマをスキップ
    if(getchar() != ',') {
        printf("エラー: カンマが見つかりません\n");
        return 1;
    }
    
    // 都市を読む（改行まで）
    result = scanf("%[^\n]", city);
    if(result != 1) {
        printf("エラー: 都市の読み取りに失敗しました\n");
        return 1;
    }
    getchar();
    
    // 結果表示
    printf("\n========== 読み取り結果 ==========\n");
    printf("名前: %s\n", name);
    printf("年齢: %d歳\n", age);
    printf("都市: %s\n", city);
    printf("==================================\n");
    
    return 0;
}
```

実行例:
```
CSV形式でデータを入力してください
形式: 名前,年齢,都市
例: 山田太郎,25,東京

データ: 山田太郎,25,東京

========== 読み取り結果 ==========
名前: 山田太郎
年齢: 25歳
都市: 東京
==================================
```


---

## よくある間違いと対策

### 間違い1: バッファクリアを忘れる

`scanf()` の後にバッファクリアを行わないと、残ったデータが次の入力に影響します。特にループ内や連続した入力処理では必須です。すべての `scanf()` の後に `while(getchar() != '\n')` を付ける習慣をつけることで、この問題を防げます。

```c
// ❌ 間違い
int num1, num2;
scanf("%d", &num1);
scanf("%d", &num2);  // 前の入力の残りが影響する

// ✅ 正しい
int num1, num2;
scanf("%d", &num1);
while(getchar() != '\n');  // バッファクリア
scanf("%d", &num2);
while(getchar() != '\n');  // バッファクリア
```

### 間違い2: 配列に & を付ける

配列名はすでにアドレスを表すため、`&` を付けると警告が出ます。配列の場合は `&` なしで、通常の変数の場合は `&` 付きで渡します。この違いを理解することが重要です。

```c
// ❌ 間違い
char str[100];
scanf("%s", &str);  // 警告が出る

// ✅ 正しい
char str[100];
scanf("%s", str);  // 配列名はアドレス
```

### 間違い3: エラーチェックをしない

`scanf()` の戻り値をチェックしないと、入力失敗に気づけません。不正なデータが変数に入ったまま処理が続行され、予期しない動作を引き起こします。必ず戻り値をチェックし、失敗時の処理を実装します。

```c
// ❌ 間違い
int num;
scanf("%d", &num);  // 失敗しても気づかない
printf("数値: %d\n", num);  // 不定値が出力される可能性

// ✅ 正しい
int num;
int result = scanf("%d", &num);
while(getchar() != '\n');

if(result != 1) {
    printf("エラー: 数値の読み取りに失敗しました\n");
    return 1;
}
printf("数値: %d\n", num);
```

### 間違い4: %c の前にバッファクリアしない

`%c` は空白や改行も文字として読み取ります。前の入力で残った改行が読み取られてしまうため、`%c` の前には必ずバッファクリアが必要です。または、書式指定子の前に空白を入れることで、空白文字をスキップできます。

```c
// ❌ 間違い
int num;
char ch;
scanf("%d", &num);
scanf("%c", &ch);  // 改行が読み取られる

// ✅ 正しい（方法1: バッファクリア）
int num;
char ch;
scanf("%d", &num);
while(getchar() != '\n');
scanf("%c", &ch);

// ✅ 正しい（方法2: 空白でスキップ）
int num;
char ch;
scanf("%d", &num);
scanf(" %c", &ch);  // 先頭の空白で改行をスキップ
```

### 間違い5: バッファオーバーフロー

配列のサイズを超える文字列を読み取ると、バッファオーバーフローが発生します。`scanf()` では幅指定を使って読み取る文字数を制限できます。セキュリティ上重要な対策で、必ず実装すべきです。

```c
// ❌ 危険
char str[10];
scanf("%s", str);  // 10文字以上入力されるとバッファオーバーフロー

// ✅ 安全
char str[10];
scanf("%9s", str);  // 最大9文字（+終端文字で10文字）
while(getchar() != '\n');
```

---

## まとめ

### scanf() 使用時の鉄則

1. **必ず戻り値をチェックする**: 入力が成功したか確認
2. **必ずバッファクリアする**: `while(getchar() != '\n')` を忘れない
3. **配列には & を付けない**: 配列名はアドレス
4. **バッファオーバーフローに注意**: 幅指定を使う
5. **エラー時は再入力を促す**: ユーザーフレンドリーな設計

```c
// 推奨パターン
int value;
int result;

do {
    printf("入力: ");
    result = scanf("%d", &value);
    while(getchar() != '\n');  // 必須
    
    if(result != 1) {
        printf("エラー: 数値を入力してください\n");
    }
} while(result != 1);
```

### printf() 使用時のポイント

1. **幅指定で整形**: 表形式の出力に便利
2. **桁数指定で精度制御**: 小数点以下の桁数を統一
3. **フラグで細かく制御**: 符号表示、ゼロ埋めなど
4. **戻り値で出力確認**: エラー検出に使える

```c
// 推奨パターン（表形式）
printf("%-20s %10d %12.2f\n", name, quantity, price);
```

### バッファクリアの使い分け

| 状況 | 方法 |
|------|------|
| 通常の `scanf()` 後 | `while(getchar() != '\n');` |
| `%[^\n]` で行全体を読んだ後 | `getchar();` |
| 連続する同形式の入力 | 最後に1回だけ |
| ループ内の `scanf()` | 毎回必須 |

### エラー処理の基本パターン

```c
// パターン1: 単純なチェック
if(scanf("%d", &num) != 1) {
    printf("エラー\n");
    return 1;
}

// パターン2: ループで再入力
do {
    result = scanf("%d", &num);
    while(getchar() != '\n');
    if(result != 1) printf("エラー\n");
} while(result != 1);

// パターン3: 範囲チェック付き
do {
    result = scanf("%d", &num);
    while(getchar() != '\n');
    if(result != 1) {
        printf("エラー: 数値を入力\n");
    } else if(num < min || num > max) {
        printf("エラー: 範囲外\n");
        result = 0;
    }
} while(result != 1);
```

---

## 参考資料

- C言語標準ライブラリ: `<s